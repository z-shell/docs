emulate -LR zsh
setopt extendedglob warncreateglobal typesetsilent noshortloops rcquotes

REPLY=

local pkg=$1 nl=$'\n'
integer retry=3

+zi-message "{info}Downloading{ehi}: {obj}mirrors.lst{info}{…}{rst}"
local mlst="$(mktemp)"
while (( retry -- )) {
  if ! .zi-download-file-stdout https://cygwin.com/mirrors.lst 0 > $mlst; then
    .zi-download-file-stdout https://cygwin.com/mirrors.lst 1 > $mlst
  fi

  local -a mlist
  mlist=( "${(@f)$(<$mlst)}" )

  local mirror=${${mlist[ RANDOM % (${#mlist} + 1) ]}%%;*}
  [[ -n $mirror ]] && break
}

if [[ -z $mirror ]] {
  +zi-message "{error}Couldn't download{error}: {obj}mirrors.lst {error}."
  return 1
}

mirror=http://ftp.eq.uc.pt/software/pc/prog/cygwin/

+zi-message "{info2}Selected mirror is{error}: {url}${mirror}{rst}"
+zi-message "{info}Downloading{ehi}: {file}setup.ini.bz2{info}{…}{rst}"
local setup="$(mktemp -u)"
retry=3
while (( retry -- )) {
  if ! .zi-download-file-stdout ${mirror}x86_64/setup.bz2 0 1 > $setup.bz2; then
    .zi-download-file-stdout ${mirror}x86_64/setup.bz2 1 1 > $setup.bz2
  fi

  command bunzip2 "$setup.bz2" 2>/dev/null
  [[ -s $setup ]] && break
  mirror=${${mlist[ RANDOM % (${#mlist} + 1) ]}%%;*}
  +zi-message "{pre}Retrying{error}: {meta}#{obj}$(( 3 - $retry ))/3, {pre}with mirror{error}: {url}${mirror}{rst}"
}
local setup_contents="$(command grep -A 26 "@ $pkg\$" "$setup")"
local urlpart=${${(S)setup_contents/(#b)*@ $pkg${nl}*install: (*)$nl*/$match[1]}%% *}
if [[ -z $urlpart ]] {
  +zi-message "{error}Couldn't find package{error}: {data2}\`{data}${pkg}{data2}'{error}.{rst}"
  return 2
}
local url=$mirror/$urlpart outfile=${TMPDIR:-${TMPDIR:-/tmp}}/${urlpart:t}

+zi-message "{info}Downloading{ehi}: {file}${url:t}{info}{…}{rst}"
retry=2
while (( retry -- )) {
  integer retval=0
  if ! .zi-download-file-stdout $url 0 1 > $outfile; then
    if ! .zi-download-file-stdout $url 1 1 > $outfile; then
      +zi-message "{error}Couldn't download{error}: {url}${url}{error}."
      retval=1
      mirror=${${mlist[ RANDOM % (${#mlist} + 1) ]}%%;*}
      url=$mirror/$urlpart outfile=${TMPDIR:-${TMPDIR:-/tmp}}/${urlpart:t}
      if (( retry )) {
        +zi-message "{info2}Retrying, with mirror{error}: {url}${mirror}{info2}{…}{rst}"
        continue
      }
    fi
  fi
  break
}
REPLY=$outfile
