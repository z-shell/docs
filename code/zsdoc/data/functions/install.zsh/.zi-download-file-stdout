local url="$1" restart="$2" progress="${(M)3:#1}"

emulate -LR zsh
setopt localtraps extendedglob

if (( restart )) {
  (( ${path[(I)/usr/local/bin]} )) || {
      path+=( "/usr/local/bin" );
      trap "path[-1]=()" EXIT
    }

  if (( ${+commands[curl]} )); then
    if [[ -n $progress ]]; then
      command curl --progress-bar -fSL "$url" 2> >($ZI[BIN_DIR]/lib/zsh/single-line.zsh >&2) || return 1
    else
      command curl -fsSL "$url" || return 1
    fi
  elif (( ${+commands[wget]} )); then
    command wget ${${progress:--q}:#1} "$url" -O - || return 1
  elif (( ${+commands[lftp]} )); then
    command lftp -c "cat $url" || return 1
  elif (( ${+commands[lynx]} )); then
    command lynx -source "$url" || return 1
  else
    +zi-message "{u-warn}ERROR{b-warn}:{rst}No download tool detected" \
      "(one of: {cmd}curl{rst}, {cmd}wget{rst}, {cmd}lftp{rst}," "{cmd}lynx{rst})."
    return 2
  fi
} else {
  if type curl 2>/dev/null 1>&2; then
    if [[ -n $progress ]]; then
      command curl --progress-bar -fSL "$url" 2> >($ZI[BIN_DIR]/lib/zsh/single-line.zsh >&2) || return 1
    else
      command curl -fsSL "$url" || return 1
    fi
  elif type wget 2>/dev/null 1>&2; then
    command wget ${${progress:--q}:#1} "$url" -O - || return 1
  elif type lftp 2>/dev/null 1>&2; then
    command lftp -c "cat $url" || return 1
  else
    .zi-download-file-stdout "$url" "1" "$progress"
    return $?
  fi
}

return 0
