builtin emulate -LR zsh
setopt nullglob extendedglob warncreateglobal typesetsilent noshortloops

local id_as=$1${2:+${${${(M)1:#%}:+$2}:-/$2}}
local reinstall=${3:-0} quiet=${${4:+1}:-0}
(( OPTS[opt_-q,--quiet] )) && quiet=1
[[ $4 = -Q ]] && quiet=2
typeset -ga INSTALLED_COMPS SKIPPED_COMPS
INSTALLED_COMPS=() SKIPPED_COMPS=()

.zi-any-to-user-plugin "$id_as" ""
local user=${reply[-2]}
local plugin=${reply[-1]}
.zi-any-colorify-as-uspl2 "$user" "$plugin"
local abbrev_pspec=$REPLY

.zi-exists-physically-message "$id_as" "" || return 1
typeset -a completions already_symlinked backup_comps
local c cfile bkpfile
[[ $user == % || ( -z $user && $plugin == . ) ]] && \
  completions=( "${plugin}"/**/_[^_.]*~*(*.zwc|*.html|*.txt|*.png|*.jpg|*.jpeg|*.js|*.md|*.yml|*.ri|_zsh_highlight*|/zsdoc/*|*.ps1)(DN^/) ) || \
  completions=( "${ZI[PLUGINS_DIR]}/${id_as//\//---}"/**/_[^_.]*~*(*.zwc|*.html|*.txt|*.png|*.jpg|*.jpeg|*.js|*.md|*.yml|*.ri|_zsh_highlight*|/zsdoc/*|*.ps1)(DN^/) )
already_symlinked=( "${ZI[COMPLETIONS_DIR]}"/_[^_.]*~*.zwc(DN) )
backup_comps=( "${ZI[COMPLETIONS_DIR]}"/[^_.]*~*.zwc(DN) )
for c in "${completions[@]}"; do
  cfile="${c:t}"
  bkpfile="${cfile#_}"
  if [[ ( -z ${already_symlinked[(r)*/$cfile]} || $reinstall = 1 ) &&
    -z ${backup_comps[(r)*/$bkpfile]}
  ]]; then
    if [[ $reinstall = 1 ]]; then
      command rm -f "${ZI[COMPLETIONS_DIR]}/$cfile" "${ZI[COMPLETIONS_DIR]}/$bkpfile"
    fi
    INSTALLED_COMPS+=( $cfile )
    (( quiet )) || builtin print -Pr "Symlinking completion ${ZI[col-uname]}$cfile%f%b to completions directory."
    command ln -fs "$c" "${ZI[COMPLETIONS_DIR]}/$cfile"
    .zi-forget-completion "$cfile" "$quiet"
  else
    SKIPPED_COMPS+=( $cfile )
    (( quiet )) || builtin print -Pr "Not symlinking completion \`${ZI[col-obj]}$cfile%f%b', it already exists."
    (( quiet )) || builtin print -Pr "${ZI[col-info2]}Use \`${ZI[col-pname]}zi creinstall $abbrev_pspec${ZI[col-info2]}' to force install.%f%b"
  fi
done

if (( quiet == 1 && (${#INSTALLED_COMPS} || ${#SKIPPED_COMPS}) )) {
  +zi-message "{msg}Installed {num}${#INSTALLED_COMPS}" \
    "{msg}completions. They are stored in{var}" \
    "\$INSTALLED_COMPS{msg} array."
  if (( ${#SKIPPED_COMPS} )) {
    +zi-message "{msg}Skipped installing" \
      "{num}${#SKIPPED_COMPS}{msg} completions." \
      "They are stored in {var}\$SKIPPED_COMPS{msg} array."
  }
}

if (( ZSH_SUBSHELL )) {
  builtin print -rl -- $INSTALLED_COMPS >| ${TMPDIR:-/tmp}/zi.installed_comps.$$.lst
  builtin print -rl -- $SKIPPED_COMPS >| ${TMPDIR:-/tmp}/zi.skipped_comps.$$.lst
}

.zi-compinit 1 1 &>/dev/null
