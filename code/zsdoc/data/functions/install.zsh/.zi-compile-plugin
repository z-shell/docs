builtin emulate -LR zsh
builtin setopt extendedglob warncreateglobal typesetsilent noshortloops rcquotes

local id_as=$1${2:+${${${(M)1:#%}:+$2}:-/$2}} first plugin_dir filename is_snippet
local -a list
local -A ICE
.zi-compute-ice "$id_as" "pack" \
  ICE plugin_dir filename is_snippet || return 1

if [[ ${ICE[pick]} != /dev/null && ${ICE[as]} != null && \
  ${+ICE[null]} -eq 0 && ${ICE[as]} != command && ${+ICE[binary]} -eq 0 && ( ${+ICE[nocompile]} = 0 || ${ICE[nocompile]} = \! ) ]] {
  reply=()
  if [[ -n ${ICE[pick]} ]]; then
    list=( ${~${(M)ICE[pick]:#/*}:-$plugin_dir/$ICE[pick]}(DN) )
    if [[ ${#list} -eq 0 ]] {
      builtin print "No files for compilation found (pick-ice didn't match)."
      return 1
    }
    reply=( "${list[1]:h}" "${list[1]}" )
  else
    if (( is_snippet )) {
      if [[ -f $plugin_dir/$filename ]] {
        reply=( "$plugin_dir" $plugin_dir/$filename )
      } elif { ! .zi-first % "$plugin_dir" } {
        +zi-message "No files for compilation found."
        return 1
      }
    } else {
      .zi-first "$1" "$2" || {
        +zi-message "No files for compilation found."
        return 1
      }
    }
  fi
  local pdir_path=${reply[-2]}
  first=${reply[-1]}
  local fname=${first#$pdir_path/}

  +zi-message -n "{note}Note:{rst} Compiling{ehi}:{rst} {b}{file}$fname{rst}{…}"
  if [[ -z ${ICE[(i)(\!|)(sh|bash|ksh|csh)]} ]] {
    () {
      builtin emulate -LR zsh -o extendedglob
      if { ! zcompile -U "$first" } {
        +zi-message "{msg2}Warning:{rst} Compilation failed. Don't worry, the plugin will work also without compilation."
        +zi-message "{msg2}Warning:{rst} Consider submitting an error report to ❮ ZI ❯ or to the plugin's author."
      } else {
        +zi-message " {ok}OK{rst}."
      }
      zcompile -U "${${first%.plugin.zsh}%.zsh-theme}.zsh" 2>/dev/null
    }
  }
}

if [[ -n "${ICE[compile]}" ]]; then
  local -a pats
  pats=( ${(s.;.)ICE[compile]} )
  local pat
  list=()
  for pat ( $pats ) {
    eval "list+=( \$plugin_dir/$~pat(N) )"
  }
  if [[ ${#list} -eq 0 ]] {
    +zi-message "{u-warn}Warning{b-warn}:{rst} ice {ice}compile{apo}''{rst} didn't match any files."
  } else {
    integer retval
    for first in $list; do
      () {
        builtin emulate -LR zsh -o extendedglob
        zcompile -U "$first"; retval+=$?
      }
    done
    builtin print -rl -- ${list[@]#$plugin_dir/} >| ${TMPDIR:-/tmp}/zi.compiled.$$.lst
    if (( retval )) {
      +zi-message "{note}Note:{rst} The additional {num}${#list}{rst} compiled files" \
        "are listed in the {var}\$ADD_COMPILED{rst} array (operation exit" \
        "code: {ehi}$retval{rst})."
    } else {
      +zi-message "{note}Note:{rst} The additional {num}${#list}{rst} compiled files" \
        "are listed in the {var}\$ADD_COMPILED{rst} array."
    }
  }
fi

return 0
