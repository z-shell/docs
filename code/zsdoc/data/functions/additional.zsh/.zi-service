emulate -LR zsh
setopt extendedglob warncreateglobal typesetsilent noshortloops
local ___tpe="$1" ___mode="$2" ___id="$3" ___fle="${ZI[SERVICES_DIR]}/${ICE[service]}.lock" ___fd ___cmd ___tmp ___lckd ___strd=0
{ builtin print -n >| "$___fle"; } 2>/dev/null 1>&2
[[ ! -e ${___fle:r}.fifo ]] && command mkfifo "${___fle:r}.fifo" 2>/dev/null 1>&2
[[ ! -e ${___fle:r}.fifo2 ]] && command mkfifo "${___fle:r}.fifo2" 2>/dev/null 1>&2
typeset -g ZSRV_WORK_DIR="${ZI[SERVICES_DIR]}" ZSRV_ID="${ICE[service]}"
while (( 1 )); do
  (
    while (( 1 )); do
      [[ ! -f ${___fle:r}.stop ]] && if (( ___lckd )) || zsystem 2>/dev/null 1>&2 flock -t 1 -f ___fd -e $___fle; then
        ___lckd=1
        if (( ! ___strd )) || [[ $___cmd = RESTART ]]; then
          [[ $___tpe = p ]] && { ___strd=1; .zi-load "$___id" "" "$___mode"; }
          [[ $___tpe = s ]] && { ___strd=1; .zi-load-snippet "$___id" ""; }
        fi
        ___cmd=
        while (( 1 )); do builtin read -t 32767 ___cmd <>"${___fle:r}.fifo" && break; done
      else
        return 0
      fi
      [[ $___cmd = (#i)NEXT ]] && { kill -TERM "$ZSRV_PID"; builtin read -t 2 ___tmp <>"${___fle:r}.fifo2"; kill -HUP "$ZSRV_PID"; exec {___fd}>&-; ___lckd=0; ___strd=0; builtin read -t 10 ___tmp <>"${___fle:r}.fifo2"; }
      [[ $___cmd = (#i)STOP ]] && { kill -TERM "$ZSRV_PID"; builtin read -t 2 ___tmp <>"${___fle:r}.fifo2"; kill -HUP "$ZSRV_PID"; ___strd=0; builtin print >| "${___fle:r}.stop"; }
      [[ $___cmd = (#i)QUIT ]] && { kill -HUP ${sysparams[pid]}; return 1; }
      [[ $___cmd != (#i)RESTART ]] && { ___cmd=; builtin read -t 1 ___tmp <>"${___fle:r}.fifo2"; }
    done
  ) || break
  builtin read -t 1 ___tmp <>"${___fle:r}.fifo2"
done >>| "$ZSRV_WORK_DIR/$ZSRV_ID".log 2>&1
