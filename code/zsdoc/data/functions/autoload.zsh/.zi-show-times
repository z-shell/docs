emulate -LR zsh
setopt  extendedglob warncreateglobal noshortloops
local opt="$1 $2 $3" entry entry2 entry3 user plugin
float -F 3 sum=0.0
local -A sice
local -a tmp
[[ "$opt" = *-[a-z]#m[a-z]#* ]] && \
  { builtin print "Plugin loading moments (relative to the first prompt):"; ((1)); } || \
  builtin print "Plugin loading times:"
for entry in "${(@on)ZI[(I)TIME_[0-9]##_*]}"; do
  entry2="${entry#TIME_[0-9]##_}"
  entry3="AT_$entry"
  if [[ "$entry2" = (http|https|ftp|ftps|scp|${(~j.|.)${${(k)ZI_1MAP}%::}}):* ]]; then
    REPLY="${ZI[col-pname]}$entry2${ZI[col-rst]}"
    tmp=( "${(z@)ZI_SICE[${entry2%/}]}" )
    (( ${#tmp} > 1 && ${#tmp} % 2 == 0 )) && sice=( "${(Q)tmp[@]}" ) || sice=()
  else
    user="${entry2%%---*}"
    plugin="${entry2#*---}"
    [[ "$user" = \% ]] && plugin="/${plugin//---/\/}"
    [[ "$user" = "$plugin" && "$user/$plugin" != "$entry2" ]] && user=""
    .zi-any-colorify-as-uspl2 "$user" "$plugin"
    tmp=( "${(z@)ZI_SICE[$user/$plugin]}" )
    (( ${#tmp} > 1 && ${#tmp} % 2 == 0 )) && sice=( "${(Q)tmp[@]}" ) || sice=()
  fi
  local attime=$(( ZI[$entry3] - ZI[START_TIME] ))
  if [[ "$opt" = *-[a-z]#s[a-z]#* ]]; then
    local time="$ZI[$entry] sec"
    attime="${(M)attime#*.???} sec"
  else
    local time="${(l:5:: :)$(( ZI[$entry] * 1000 ))%%[,.]*} ms"
    attime="${(l:5:: :)$(( attime * 1000 ))%%[,.]*} ms"
  fi
  [[ -z $EPOCHREALTIME ]] && attime="<no zsh/datetime module â†’ no time data>"
  if [[ "$opt" = *-[a-z]#m[a-z]#* ]]; then
    time="$attime"
  fi
  if [[ ${sice[as]} == "command" ]]; then
    builtin print "$time" - "$REPLY (command)"
  elif [[ -n ${sice[sbin]+abc} ]]; then
    builtin print "$time" - "$REPLY (sbin command)"
  elif [[ -n ${sice[fbin]+abc} ]]; then
    builtin print "$time" - "$REPLY (fbin command)"
  elif [[ ( ${sice[pick]} = /dev/null || ${sice[as]} = null ) && ${+sice[make]} = 1 ]]; then
    builtin print "$time" - "$REPLY (/dev/null make plugin)"
  else
    builtin print "$time" - "$REPLY"
  fi
  (( sum += ZI[$entry] ))
done
builtin print "Total: $sum sec"
