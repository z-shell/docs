if command git -C "${${ZI[ZMODULES_DIR]}}/zpmod" rev-parse 2>/dev/null; then
  command git -C "${${ZI[ZMODULES_DIR]}}/zpmod" clean -d -f -f
  command git -C "${${ZI[ZMODULES_DIR]}}/zpmod" reset --hard HEAD
  command git -C "${${ZI[ZMODULES_DIR]}}/zpmod" pull
else
  if ! test -d "${${ZI[ZMODULES_DIR]}}/zpmod"; then
    mkdir -p "${${ZI[ZMODULES_DIR]}}/zpmod"
    chmod g-rwX "${${ZI[ZMODULES_DIR]}}/zpmod"
  fi
  command git clone "https://github.com/z-shell/zpmod.git" "${${ZI[ZMODULES_DIR]}}/zpmod" || {
    builtin print "${ZI[col-error]}Failed to clone module repo${ZI[col-rst]}"
    return 1
  }
fi
( builtin cd -q "${ZI[ZMODULES_DIR]}/zpmod"
  +zi-message "{pname}== Building module zi/zpmod, running: make clean, then ./configure and then make =={rst}"
  +zi-message "{pname}== The module sources are located at: "${ZI[ZMODULES_DIR]}/zpmod" =={rst}"
  if [[ -f Makefile ]] {
    if [[ "$1" = "--clean" ]] {
      noglob +zi-message {p}-- make distclean --{rst}
      make distclean
      ((1))
    } else {
      noglob +zi-message {p}-- make clean --{rst}
      make clean
    }
  }
  noglob +zi-message  {p}-- ./configure --{rst}
  CPPFLAGS=-I/usr/local/include CFLAGS="-g -Wall -O3" LDFLAGS=-L/usr/local/lib ./configure --disable-gdbm --without-tcsetpgrp && {
    noglob +zi-message {p}-- make --{rst}
    if { make } {
      [[ -f Src/zi/zpmod.so ]] && cp -vf Src/zi/zpmod.{so,bundle}
      noglob +zi-message "{info}Module has been built correctly.{rst}"
      .zi-module info
    } else {
      noglob +zi-message  "{error}Module didn't build.{rst} "
      .zi-module info --link
    }
  }
  builtin print $EPOCHSECONDS >| "${ZI[ZMODULES_DIR]}/zpmod/COMPILED_AT"
)
