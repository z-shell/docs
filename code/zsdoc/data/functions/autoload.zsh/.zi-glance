.zi-any-to-user-plugin "$1" "$2"
local user="${reply[-2]}" plugin="${reply[-1]}"

.zi-exists-physically-message "$user" "$plugin" || return 1

.zi-first "$1" "$2" || {
  builtin print "${ZI[col-error]}No source file found, cannot glance${ZI[col-rst]}"
  return 1
}
local fname="${reply[-1]}"

integer has_256_colors=0
[[ "$TERM" = xterm* || "$TERM" = "screen" ]] && has_256_colors=1
{
  if (( ${+commands[pygmentize]} )); then
    builtin print "Glancing with ${ZI[col-info]}pygmentize${ZI[col-rst]}"
    pygmentize -l bash -g "$fname"
  elif (( ${+commands[highlight]} )); then
    builtin print "Glancing with ${ZI[col-info]}highlight${ZI[col-rst]}"
    if (( has_256_colors )); then
      highlight -q --force -S sh -O xterm256 "$fname"
    else
      highlight -q --force -S sh -O ansi "$fname"
    fi
  elif (( ${+commands[source-highlight]} )); then
    builtin print "Glancing with ${ZI[col-info]}source-highlight${ZI[col-rst]}"
    source-highlight -fesc --failsafe -s zsh -o STDOUT -i "$fname"
  else
    cat "$fname"
  fi
} | {
  if [[ -t 1 ]]; then
    .zi-pager
  else
    cat
  fi
}
