---
name: üìñ Code
on:
  workflow_dispatch:
  schedule:
    - cron: "30 4 * * 4"

jobs:
  deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
      - name: ‚ö° Install zsdoc
        run: |
          sudo apt-get install -y zsh tree
          sudo make -C lib/zsdoc install
      - name: üíé Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0
          bundler-cache: true
      - name: üìù Install asciidoctor-pdf and rouge
        run: |
          gem install asciidoctor-pdf rouge
      - name: ‚ôªÔ∏è Generate Asciidoc
        run: make -C code adoc
      - name: ‚ôªÔ∏è Generate PDF
        run: make -C code/zsdoc pdf
      - name: ‚ôªÔ∏è Generate HTML
        run: make -C code/zsdoc html
      - name: ‚ôªÔ∏è Cleanup
        run: make -C code clean
      - name: üèó Compress code documentation
        run: tar cvzf code.tar.gz code
      - name: üì§ Upload code.tar.gz
        uses: actions/upload-artifact@v2
        with:
          name: code documentation
          path: code.tar.gz
      - name: Tree
        run: |
          echo -e "```SystemVerilog"
          tree code/zsdoc | tee docs/TREE.md
          tree wiki/zsh | tee -a docs/TREE.md
          tree wiki/zi | tee -a docs/TREE.md
          echo -e "```"

      - name: üöÄ Commit & push changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Code Documentation Update"
          # Defaults to the current branch.
          #branch: main
          # See https://git-scm.com/docs/git-commit#_options
          commit_options: "--no-verify --signoff"
          # See the `pathspec`-documentation for git
          # - https://git-scm.com/docs/git-add#Documentation/git-add.txt-ltpathspecgt82308203
          # - https://git-scm.com/docs/gitglossary#Documentation/gitglossary.txt-aiddefpathspecapathspec
          file_pattern: code docs
          # Defaults to the root of the repository
          #repository:
          #commit_user_name: Z-Shell Bot
          #commit_user_email: z-shell@digitalclouds.dev
          #commit_author: Z-Shell ZI <z-shell@digitalclouds.dev>
          #tagging_message: 'v1.0.0'
          # See https://git-scm.com/docs/git-status#_options
          status_options: "--untracked-files=no"
          # See https://git-scm.com/docs/git-add#_options
          #add_options: '-u'
          push_options: "--force"
          skip_dirty_check: true
          skip_fetch: true
          # Details: https://www.gnu.org/software/bash/manual/html_node/Filename-Expansion.html
          disable_globbing: true
          if: steps.auto-commit-action.outputs.changes_detected == 'false'
          run: echo "No Changes!"
