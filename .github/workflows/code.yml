---
name: ðŸ“– Code Documentation
on:
  workflow_dispatch:
  schedule:
    - cron: "30 4 * * 4"

jobs:
  deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: mktcode/consecutive-workflow-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: 'true'
      - name: Install zsdoc
        run: |
          sudo apt-get install -y zsh tree
          git submodule --init --recursive
          sudo make -C lib/zsdoc install
      - name: ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0
          bundler-cache: true
      - name: asciidoctor-pdf
        run: |
          gem install asciidoctor-pdf rouge
  generate:
    runs-on: ubuntu-latest
    needs: [ deps ]
    steps:
      - name: Generate Asciidoc
        run: make -C code adoc
      - name: Generate PDF
        run: make -C code/zsdoc pdf
      - name: Generate HTML
        run: make -C code/zsdoc html
      - name: Cleanup
        run: make -C code clean
      - name: Tar Code documentation
        run: tar cvzf code.tar.gz code
      - name: Upload code.tar.gz
        uses: actions/upload-artifact@v2
        with:
          name: code documentation
          path: code.tar.gz
      - name: Tree
        run: |
          echo -e "```SystemVerilog"
          tree code/zsdoc | tee docs/TREE.md
          tree wiki/zsh | tee -a docs/TREE.md
          tree wiki/zi | tee -a docs/TREE.md
          echo -e "```"
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Code Documentation Update"
          branch: main
          # See https://git-scm.com/docs/git-commit#_options
          commit_options: "--no-verify --signoff"
          # See the `pathspec`-documentation for git
          # - https://git-scm.com/docs/git-add#Documentation/git-add.txt-ltpathspecgt82308203
          # - https://git-scm.com/docs/gitglossary#Documentation/gitglossary.txt-aiddefpathspecapathspec
          file_pattern: code docs
          repository: .
          commit_user_name: Z-Shell Bot
          commit_user_email: z-shell@digitalclouds.dev
          commit_author: Z-Shell ZI <z-shell@digitalclouds.dev>
          #tagging_message: 'v1.0.0'
          # See https://git-scm.com/docs/git-status#_options
          status_options: "--untracked-files=no"
          # See https://git-scm.com/docs/git-add#_options
          #add_options: '-u'
          push_options: "--force"
          skip_dirty_check: true
          skip_fetch: true
          # Details: https://www.gnu.org/software/bash/manual/html_node/Filename-Expansion.html
          disable_globbing: true
